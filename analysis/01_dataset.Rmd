---
title: "01_dataset_creation"
author: "Miguel √Ångel Armengol"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  # html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes

knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4)," ",Sys.Date(),'.html')) })
---

# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(summarytools)
library(readr)
library(magrittr)
library(sqldf)
library(dplyr)
library(tableone)
library(kableExtra)
library(diagram)
impute.median <- function(x) replace(x, is.na(x), median(x, na.rm = TRUE))
options(scipen=999)
library(Gmisc, quietly = TRUE)
library(glue)
library(grid)
library(magrittr)
```


# Set up BigQuery related functions

This chunks also creates the run_query and get_sql function.

```{r setup, include=FALSE}
# Updated for our year
project_id <- "hst-953-2018"
options(httr_oauth_cache=FALSE)
# Function that takes in a sql command and runs it on bigquery
run_query <- function(query){
  data <- bq_table_download(bq_project_query(x=project_id,query=query, use_legacy_sql=FALSE,max_pages = Inf))
  return(data)
}

# function for reading sql files
getSQL <- function(filepath){
  con = file(filepath, "r")
  sql.string <- ""

  while (TRUE){
    line <- readLines(con, n = 1)

    if ( length(line) == 0 ){
      break
    }

    line <- gsub("\\t", " ", line)

    if(grepl("--",line) == TRUE){
      line <- paste(sub("--","/*",line),"*/")
    }

    sql.string <- paste(sql.string, line)
  }

  close(con)
  return(sql.string)
}

'%!in%' <- function(x,y)!('%in%'(x,y))
```

# Extracting data

Loads all queries from the sql files in the extraction folder and runs them into RBigQuey to extract the data.

```{r}
apache_aggregated<- run_query(getSQL('sql/apache_aggregated.sql'))
charlson_score<- run_query(getSQL('sql/charlson_score.sql'))
demographics<- run_query(getSQL('sql/demographics.sql'))
lactate_descr <- run_query(getSQL('sql/lactate_descr.sql'))
lactate_first_elev_to_test_mins<-run_query(getSQL('sql/lactate_first_elev_to_test_mins.sql'))
lactate_first_sev_elev_to_test_mins<-run_query(getSQL('sql/lactate_first_sev_elev_to_test_mins.sql'))

lactate_max_first3days<-run_query(getSQL('sql/lactate_max_first3days.sql'))

apache_related<- run_query(getSQL('sql/apache_related.sql'))

# IMPORTANT, ACCORDING TO THE DOCUMMENTATION -1 in Apache score means missing.
apache_related$predictedHospitalMortality[apache_related$predictedHospitalMortality==(-1)] <- NA
apache_related$apache_iv[apache_related$apache_iv==(-1)] <- NA


# SOFA related variables
sofa_cv_day1_to_day4 <- run_query(getSQL("sql/sofa/sofa_cv_day1_to_day4.sql"))
sofa_renal_day1_to_day4 <- run_query(getSQL("sql/sofa/sofa_renal_day1_to_day4.sql"))
sofa_respi_day1_to_day4 <- run_query(getSQL("sql/sofa/sofa_respi_day1_to_day4.sql"))
sofa_3others_day1_to_day4 <- run_query(getSQL("sql/sofa/sofa_3others_day1_to_day4.sql"))
sofa_total_day1_to_day4 <- sqldf((getSQL("sql/sofa/sofa_total_day1_to_day4.sql")))

#qc data
qc_labs<- run_query(getSQL('sql/qc/qc_labs.sql'))
lab_data_qc <- run_query(getSQL('sql/qc/lab_data_qc.sql'))
```

# Joining all datasets

```{r}
# We are using a left join to join them
lactate_df<-Reduce(function(...) merge(..., all.x=TRUE), list(
   demographics
  ,apache_aggregated
  ,apache_related
  ,charlson_score%>%select(patientunitstayid,final_charlson_score)
  ,lactate_descr
  ,lactate_first_elev_to_test_mins
  ,lactate_first_sev_elev_to_test_mins
  ,lactate_max_first3days
  ,sofa_total_day1_to_day4
  ,qc_labs
  ,lab_data_qc
))
```

# Selecting only relevant variables

```{r}
lactate_df
```


# Imputing missing values

```{r}
BMI
body_surface_area
actualicumortality
unabridgedactualventdays
apache_iv
lactate_fst
lactate_max
```


# Exclusion criteria 1

Patients with sepsis (not bleeding) 

```{r}
# we want to include septic patients that are not bleeding.

print('Initial number of patients:')
a <- nrow(lactate_df)
a

print('Patients <18 that are excluded:')
lactate_df %<>% filter(age_fixed > 18)
b <- nrow(lactate_df)
a - b

print('Patients with no Hgb data that are excluded:')
lactate_df %<>% filter(patientunitstayid %in% lab_data_qc$patientunitstayid)
c <- nrow(lactate_df)
b - c

print('Patients with stays shorter than 3 hours that are excluded:')
lactate_df %<>% filter(icu_los_hours >= 3)
d <- nrow(lactate_df)
c - d

print('Patients without a diagnose that are excluded:')
lactate_df %<>% filter(apacheadmissiondx != "")
e <- nrow(lactate_df)
d-e
#####################################################################################################
# we are extracting top n apache groups
topn <- 5
top_apachedxgroup <- tail(names(sort(table(lactate_df$apachedxgroup_mod))), topn) 

lactate_df <- lactate_df %>% mutate(apache_strat = if_else(apachedxgroup_mod %in% top_apachedxgroup, apachedxgroup_mod,'Not Top5'))
#####################################################################################################

print('Patients not in Top5 Apache groups that are excluded:')
lactate_df %<>% filter(apache_strat != "Not Top5")
f <- nrow(lactate_df)
e-f

print('Patients without one lab drawn each day for the first 3 days of admission:')
lactate_df %<>% filter(atleast_one_lab_drawn_each_day_first_3days == 1 )
g <- nrow(lactate_df)
f-g

excluding patients with no mortality

actualicumortality 

print('Final number of patients:')
nrow(lactate_df)
```

# Flowchart diagram

```{r}
# Initial number of patients
initial_patients <- boxGrob(width = .175,
                            glue("Initial number of patients",
                                 "N = {a}",
                                 a = txtInt(a),
                                 .sep = "\n"))

# Patients <18 that are excluded
patients_below_18 <- boxGrob(width = .175,
                            glue("Patients <18 excluded",
                                  "bN = {b}",
                                  b = txtInt(a - b),
                                  .sep = "\n"))

# Patients with no Hgb data that are excluded
patients_no_hgb <- boxGrob(width = .175,
                            glue("Patients without Hgb data excluded",
                                "N = {c}",
                                c = txtInt(b - c),
                                .sep = "\n"))

# Patients with stays shorter than 3 hours excluded
patients_short_stays <- boxGrob(width = .175,
                            glue("Patients short stays excluded",
                                     "N = {d}",
                                     d = txtInt(c - d),
                                     .sep = "\n"))

# Patients without a diagnose that are excluded
patients_no_diagnose <- boxGrob(width = .175,
                            glue("Patients without diagnosis excluded",
                                     "N = {e}",
                                     e = txtInt(d - e),
                                     .sep = "\n"))

# Patients not in Top5 Apache groups excluded
patients_not_top5 <- boxGrob(width = .175,
                            glue("Patients not in Top5 Apache groups excluded",
                                  "N = {f}",
                                  f = txtInt(e - f),
                                  .sep = "\n"))

# Patients without one lab drawn each day for the first 3 days of admission
patients_no_lab_drawn <- boxGrob(width = .175,
                            glue("Patients without labs drawn excluded",
                                      "N = {g}",
                                      g = txtInt(f - g),
                                      .sep = "\n"))

# Final number of patients
final_patients <- boxGrob(width = .175,
                            glue("Final number of patients",
                               "N = {n}",
                               n = txtInt(nrow(lactate_df)),
                               .sep = "\n"))

# Create connections
grid.newpage()
vert <- spreadVertical(initial_patients,
                       patients_below_18,
                       patients_no_hgb,
                       patients_short_stays,
                       patients_no_diagnose,
                       patients_not_top5,
                       patients_no_lab_drawn,
                       final_patients)

for (i in 1:(length(vert) - 1)) {
  connectGrob(vert[[i]], vert[[i + 1]], type = "vert") %>%
    print
}

# Print boxes
vert
```


```{r}
# Initial number of patients
initial_patients <- boxGrob(width = .175,
                            glue("Initial number of patients",
                                 "N = {a}",
                                 a = txtInt(a),
                                 .sep = "\n"))
# Excluded box
excluded <- boxGrob(glue("Total Excluded (N = {tot}):",
                         " - Patients <18 years old: {below_18}",
                         " - Patients without Hgb data: {no_hgb}",
                         " - Patients with stays shorter than 3 hours: {short_stays}",
                         " - Patients without a diagnose available: {no_diagnose}",
                         " - Patients not within the top5 Apache groups: {not_top5}",
                         " - Patients without one lab drawn each day for the first 3 days of admission: {no_lab_drawn}",
                         tot = txtInt(a - nrow(lactate_df)),
                         below_18 = txtInt(a - b),
                         no_hgb = txtInt(b-c),
                         short_stays = txtInt(c-d),
                         no_diagnose = txtInt(d-e),
                         not_top5 = txtInt(e - f),
                         no_lab_drawn = txtInt(f - g),
                         .sep = "\n"),
                    just = "left")


# Final number of patients
final_patients <- boxGrob(width = .175,
                            glue("Final number of patients",
                               "N = {n}",
                               n = txtInt(nrow(lactate_df)),
                               .sep = "\n"))


# Create connections
grid.newpage()
vert <- spreadVertical(initial_patients,
                       excluded,  # Include the excluded box here
                       final_patients)

for (i in 1:(length(vert) - 1)) {
  connectGrob(vert[[i]], vert[[i + 1]], type = "vert") %>%
    print
}

# Print boxes
vert

```

